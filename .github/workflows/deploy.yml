name: Dagster Deploy with dbt Build

on:
  push:
    branches:
      - "main"
      - "master"
  pull_request:
    branches:
      - "*"

# Global concurrency control for GitHub Actions
concurrency:
  group: ${{ github.ref }}/deploy
  cancel-in-progress: true

env:
  DAGSTER_CLOUD_URL: "http://weatherdec2025.dagster.cloud"
  DAGSTER_CLOUD_API_TOKEN: ${{ secrets.DAGSTER_CLOUD_API_TOKEN }}
  ENABLE_FAST_DEPLOYS: 'true'
  PYTHON_VERSION: '3.10'
  DAGSTER_CLOUD_FILE: 'dagster_cloud.yaml'
  DBT_PROJECT_DIR: 'weather_project'

# GitHub Actions workflow
jobs:
  test-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git
          curl -sL https://deb.nodesource.com/setup_16.x | sudo -E bash -
          sudo apt-get install -y nodejs
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          cd ${{ env.DBT_PROJECT_DIR }}
          pip install -r requirements.txt  # If you have dbt requirements in a separate file
          pip install dbt-core dbt-postgres  # Or your specific dbt adapter
          cd ..
      
      - name: Set up environment variables
        run: |
          # Load environment variables from .env file if it exists
          if [ -f .env ]; then
            echo "Loading environment variables from .env"
            set -a
            source .env
            set +a
          else
            echo "No .env file found, using GitHub Secrets"
          fi
      
      - name: Run dbt deps and build
        run: |
          cd ${{ env.DBT_PROJECT_DIR }}
          dbt deps
          dbt build --target dev  # Or your target environment
      
      - name: Create dagster_cloud.yaml
        run: |
          cat > ${{ env.DAGSTER_CLOUD_FILE }} << 'EOL'
          # Dagster Cloud deployment configuration
          # This file is generated by the GitHub Actions workflow
          # See: https://docs.dagster.io/dagster-cloud/developing-testing/deployment-settings
          
          concurrency:
            pools:
              granularity: 'run'  # 'op' or 'run'
              default_limit: 1
              op_granularity_run_buffer: 1
            
            runs:
              max_concurrent_runs: 10  # 1-50 for Serverless
              tag_concurrency_limits:
                - key: 'resource'
                  value: 'high_memory'
                  limit: 2
          
          run_monitoring:
            start_timeout_seconds: 1200     # 20 minutes
            cancel_timeout_seconds: 600     # 10 minutes
            max_runtime_seconds: 14400      # 4 hours
          
          run_retries:
            max_retries: 3
            retry_on_asset_or_op_failure: false
          
          sso_default_role: EDITOR  # NO_ACCESS, VIEWER, LAUNCHER, JOB_VIEWER, JOB_EDITOR, EDITOR, ADMIN
          
          non_isolated_runs:
            enabled: true
            max_concurrent_non_isolated_runs: 2
          EOL
          
          echo "Generated ${{ env.DAGSTER_CLOUD_FILE }} with deployment settings"
          cat ${{ env.DAGSTER_CLOUD_FILE }}
      
      - name: Load Dagster definitions (validation)
        run: |
          python -c "from weather.definitions import defs; print('Dagster definitions loaded successfully')"
      
      # Only run deployment on main/master branches, not on PRs
      - name: Deploy to Dagster Cloud
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        env:
          DAGSTER_CLOUD_API_TOKEN: ${{ secrets.DAGSTER_CLOUD_API_TOKEN }}
          ORGANIZATION_ID: ${{ vars.ORGANIZATION_ID }}
        run: |
          dagster-cloud serverless deploy \
            --url ${{ env.DAGSTER_CLOUD_URL }} \
            --deployment weather-prod \
            --working-directory . \
            --python-version ${{ env.PYTHON_VERSION }}
            
      - name: Verify deployment
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        run: |
          echo "Deployment to ${{ env.DAGSTER_CLOUD_URL }} completed successfully"
